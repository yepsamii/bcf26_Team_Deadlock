---
- name: Update and upgrade the system
  apt:
    update_cache: yes
    upgrade: dist
  become: true

- name: Install common dependencies
  apt:
    name:
      - curl
      - gnupg
      - apt-transport-https
      - ca-certificates
      - software-properties-common
    state: present
  become: true

# PostgreSQL Installation
- name: Add PostgreSQL APT key
  apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state: present
  become: true

- name: Add PostgreSQL APT repository
  apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
    state: present
  become: true

- name: Install PostgreSQL
  apt:
    name:
      - postgresql-16
      - postgresql-contrib-16
      - python3-psycopg2
    state: present
    update_cache: yes
  become: true

- name: Configure PostgreSQL to listen on all interfaces
  lineinfile:
    path: /etc/postgresql/16/main/postgresql.conf
    regexp: "^#?listen_addresses"
    line: "listen_addresses = '*'"
  become: true
  notify: Restart PostgreSQL

- name: Allow all connections in pg_hba.conf
  lineinfile:
    path: /etc/postgresql/16/main/pg_hba.conf
    line: "host    all             all             0.0.0.0/0               scram-sha-256"
    insertafter: EOF
  become: true
  notify: Restart PostgreSQL

- name: Start and enable PostgreSQL
  systemd:
    name: postgresql
    state: started
    enabled: yes
  become: true

- name: Set password for postgres user
  shell: |
    sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD '{{ postgres_password | default('postgres123') }}';"
  become: true

# MongoDB Installation
- name: Add MongoDB GPG key
  apt_key:
    url: https://www.mongodb.org/static/pgp/server-7.0.asc
    state: present
  become: true

- name: Add MongoDB APT repository
  apt_repository:
    repo: "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse"
    state: present
  become: true

- name: Install MongoDB
  apt:
    name: mongodb-org
    state: present
    update_cache: yes
  become: true

- name: Configure MongoDB to listen on all interfaces
  lineinfile:
    path: /etc/mongod.conf
    regexp: "^  bindIp:"
    line: "  bindIp: 0.0.0.0"
  become: true

- name: Start and enable MongoDB
  systemd:
    name: mongod
    state: started
    enabled: yes
  become: true

- name: Create MongoDB admin user
  shell: |
    mongosh admin --eval "db.createUser({user: '{{ mongodb_admin_user }}', pwd: '{{ mongodb_admin_password }}', roles: [{role: 'root', db: 'admin'}]})"
  become: true
  ignore_errors: true

- name: Enable MongoDB authentication
  blockinfile:
    path: /etc/mongod.conf
    block: |
      security:
        authorization: enabled
  become: true
  notify: Restart MongoDB

version: '3.8'

services:
  auth-service:
    build: ./services/auth
    container_name: auth_service
    environment:
      DBSTRING: postgresql://postgres:postgres123@47.128.225.20:5432
      RABBITMQ_URL: amqp://user:password@rabbitmq:5672/
      PORT: 5001 
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
    ports:
      - "5001:5001"
    depends_on:
      - otel-collector
      - prometheus
      - loki
    networks:
      - deadlock-network


  orders-service:
    build: ./services/orders
    container_name: orders-service
    environment:
      PORT: 5003
      DBSTRING: postgresql://postgres:postgres123@47.128.225.20:5432
      INVENTORY_SERVICE_URL: http://inventory-service:5002
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      RESILIENCE_TIMEOUT_SECONDS: 3
      CIRCUIT_MAX_FAILURES: 5
      CIRCUIT_TIMEOUT_SECONDS: 30
    ports:
      - "5003:5003"
    depends_on:
      - inventory-service
      - otel-collector
      - prometheus
      - loki
    networks:
      - deadlock-network


  inventory-service:
    build: ./services/inventory
    container_name: inventory_service
    environment:
      DBSTRING: postgresql://postgres:postgres123@47.128.225.20:5432
      PORT: 5002
      OTEL_EXPORTER_OTLP_ENDPOINT: otel-collector:4317
      CORS_ALLOWED_ORIGIN: http://localhost:3000
    ports:
      - "5002:5002"
    depends_on:
      - otel-collector
      - prometheus
      - loki
    networks:
      - deadlock-network

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      - PORT=5000
      - AUTH_SERVICE_URL=http://auth-service:5001
      - INVENTORY_SERVICE_URL=http://inventory-service:5002
      - ORDER_SERVICE_URL=http://orders-service:5003
    depends_on:
      - auth-service
      - inventory-service
      - orders-service
      - prometheus
      - loki
    ports:
      - "8000:5000"
    volumes:
      - ./services/api-gateway:/app
      - /app/node_modules
    networks:
      - deadlock-network

  customer-ui:
    build:
      context: ./frontend/customer-ui
      dockerfile: Dockerfile
    container_name: customer-ui
    depends_on:
      - api-gateway
    ports:
      - "3000:80"
    volumes:
      - ./frontend/customer-ui:/app
      - /app/node_modules
    networks:
      - deadlock-network

  monitoring-dashboard:
    build:
      context: ./frontend/dashboard
      dockerfile: Dockerfile
    container_name: monitoring-dashboard
    depends_on:
      - auth-service
      - inventory-service
      - orders-service
      - api-gateway
      - prometheus
    ports:
      - "3001:80"
    networks:
      - deadlock-network



  # Monitoring Services
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - deadlock-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3030:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - loki
    networks:
      - deadlock-network

  # Logging Services
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki-config.yml:/etc/loki/local-config.yaml
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - deadlock-network

  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - deadlock-network

  # Tracing Services
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config", "/etc/otel-collector-config.yml"]
    volumes:
      - ./monitoring/otel-collector-config.yml:/etc/otel-collector-config.yml
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - jaeger
    networks:
      - deadlock-network
  
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"
      - "14268:14268"
    networks:
      - deadlock-network

networks:
  deadlock-network:
    driver: bridge


